libname adam "/folders/myfolders/adam";
libname sdtm "/folders/myfolders/sdtm";
dm 'log; clear; lst; clear;';
*************************************************************
******************;
* PROGRAM     : ABDC1234\ADAM\Program\ADPD.sas
* SOFTW/PLAT. : SAS v9.4 - W32 platform* DATE        : Wed 05/26/2018 (mm/dd/yyyy)
* PROGRAMMER  : Philippe Remusat* PU* INPUT       : SDTM.PD, ADAM.ADPD
* OUTPUT      : ADPD.sas7bdat (ADAM)** MACROS      : 
********************************************************************
************;* Modifications History:*--------------------------------------
----------------------------------------;
* Modif. #01  :* Programmer  :* Date        :
* Purpose     :*******************************************************************************;options nofmterr;%let domain=ADPD;%let keepvar=STUDYID USUBJID SUBJID SITEID DOMAIN DOMAINC VISIT DESCRIP1 DESCRIP2 TYPE1 TYPE2 TYPE1C TYPE2C DTYPE1 DTYPE2 COMMENT1 COMMENT2             ;option varlenchk=nowarn;%*--- Create a Template;proc sql noprint;    create table ADAM_TEMPLATE    (    STUDYID   Char(15)                 label="Study Identifier",    USUBJID   Char(40)                 label="Unique Subject Identifier",    SUBJID    Char(10)                 label="Subject Identifier for the Study",    SITEID    Char(8)                  label="Study Site Identifier",    DOMAIN    num                      label="Domain ",    DOMAINC   Char(200)                label="Domain (C)",    VISIT     Char(200)                label="Visit",	TYPE1     num                      label="Type of deviation (1)", 	TYPE1C    Char(200)                label="Type of deviation (1)(C)",  	TYPE2     num                      label="Type of deviation (2)", 	TYPE2C    Char(200)                label="Type of deviation (2)(C)",     DESCRIP1  char(200) 			   label="Description 1",    DESCRIP2  char(200) 			   label="Description 2",	DTYPE1     char(200) 			   label="Important/Not Important 1",	DTYPE2     char(200) 			   label="Important/Not Important 2",	COMMENT1   char(200) 			   label="Reviewed by MM 1",	COMMENT2   char(200) 			   label="Reviewed by MM 2"	  );quit;*-------------------------------------------------*;* ADSL DATA                                       *;*-------------------------------------------------*;proc sort data=adam.adsl out=adsl;    by usubjid;run;*-------------------------------------------------*;* Get the Data                                    *;*-------------------------------------------------*;data dtype;    set sdtm.suppdv(where=(qnam="DVIMPRT"));    rename qval=dtype1;    dvseq=input(idvarval,best12.);proc sort;    by usubjid dvseq;run;data dtype1;*empty;    set sdtm.suppdv(where=(qnam="DVIMPRT1"));    rename qval=dtype2;    dvseq=input(idvarval,best12.);proc sort;    by usubjid dvseq;run;data comment1;    set sdtm.suppdv(where=(qnam="DVRVIEW"));    rename qval=comment1;    dvseq=input(idvarval,best12.);proc sort;    by usubjid dvseq;run;data comment2;*empty;    set sdtm.suppdv(where=(qnam="DVRVIEW1"));    rename qval=comment2;    dvseq=input(idvarval,best12.);proc sort;    by usubjid dvseq;run;data dvterm1; *empty;    set sdtm.suppdv(where=(qnam="DVTERM1"));    rename qval=dvterm1;    dvseq=input(idvarval,best12.);proc sort;    by usubjid dvseq;run;proc sort data=sdtm.dv out=dv_;    by usubjid dvseq;run;data dv(drop=domain);    merge dv_ dtype /*dtype1*/ comment1/* comment2 dvterm1*/;    by usubjid dvseq;run;data dv1;    length domainc $20. ;     set dv;    subjid=substr(usubjid,10);    siteid=substr(subjid,3,4);    if dvcat="BLINDED SECTION" then do;domain=1;domainc="DB Period";end;    if dvcat="PK AND PD SECTION" then do;domain=2;domainc="PK deviation";end;    if dvcat="OLE SECTION" then do;domain=3;domainc="OLE Period";end;    descrip1=dvterm;    /*descrip2=dvterm1;*/    if dvdecod="Consent" then type1=1;    else if dvdecod="Inclusion /   Exclusion Criteria" then type1=2;    else if dvdecod="Visit Date" then type1=3;    else if dvdecod="Patient assessments" then type1=4;    else if dvdecod="Study Drug" then type1=5;    else if dvdecod="Labs" then type1=6;    else if dvdecod="Excluded Medication" then type1=7;    else if dvdecod="Other" then type1=8;run;proc sort data=dv1 out=dv2;    by studyid usubjid subjid siteid domain domainc visit descrip1 dtype1 comment1 /*descrip2  dtype2  comment2*/ type1;run;proc transpose data=dv2 out=dv3a_;    by studyid usubjid subjid siteid domain domainc visit descrip1 dtype1 comment1/* descrip2  dtype2  comment2*/;    var type1;run;data dv3a;    set dv3a_;    rename col1=type1 col2=type2;run;proc transpose data=dv2 out=dv3b_;    by studyid usubjid subjid siteid domain domainc visit descrip1 dtype1 comment1/*descrip2  dtype2  comment2*/;    var dvdecod;run;data dv3b;    set dv3b_;    rename col1=type1c col2=type2c;run;data all;    merge dv3a dv3b;    by studyid usubjid subjid siteid domain domainc visit descrip1 dtype1 comment1/*descrip2  dtype2  comment2*/;proc sort data=all;     by USUBJID domain visit ; run; %*--- Create ADaM dataset;data &domain.;    informat _all_;    set adam_template all;     if usubjid="" then delete;    keep &keepvar.;run;data adam.&domain.;  set &domain.;run;%*--- Adjust length of varibales;data _null_;  set sashelp.vcolumn(where=(LIBNAME="ADAM" and MEMNAME="&domain." and upcase(type)="CHAR")) end=eof;  if _n_=1 then do;    call execute("proc sql noprint;");  end;  call execute("select max(length("||compress(name)||")) into: l" ||compress(name)|| " from adam.&domain.;");  if eof then do;   call execute("quit;");  end;run;data _null_;  set sashelp.vcolumn(where=(LIBNAME="ADAM" and MEMNAME="&domain.")) end=eof;  if _n_=1 then do;    call execute("data adam.&domain.(label='Protocol Deviations Analysis Dataset');");  end;  if type="char"  then do;    lentmp=symget("l"||compress(name));    if lentmp=. then lentmp=1;    call execute("attrib " || compress(name) || " length=" || compress("$" || lentmp || ".;"));  end;  else do;   if compress(format)="" then call execute("attrib " || compress(name) || " length=8.;");   if compress(format)="YYMMDD10." then call execute("attrib " || compress(name) || " format=yymmdd10.;");   if compress(format)="TIME5."    then call execute("attrib " || compress(name) || " format=time5.;");  end;  if eof then do;    call execute("set adam.&domain.;run;");  end;run;        